# Configuration Nixpacks pour Prisma 7
# Node.js 20 LTS (compatible Prisma 7: minimum 20.9.0+)
# Note: Node.js 22.11.0 < 22.12.0 requis par Prisma 7 (incompatible)

[variables]
CI = "true"
NODE_ENV = "production"
NPM_CONFIG_PRODUCTION = "false"

[phases.setup]
# Node.js 22 gÃ©rÃ© par NIXPACKS_NODE_VERSION=22 (dÃ©fini dans Coolify)
nixPkgs = ["pnpm-9_x", "openssl"]
nixLibs = ["libuuid", "libGL"]
aptPkgs = ["curl", "wget"]
nixOverlays = ["https://github.com/railwayapp/nix-npm-overlay/archive/main.tar.gz"]

[phases.install]
dependsOn = ["setup"]
cmds = ["pnpm i --frozen-lockfile"]
cacheDirectories = ["/root/.local/share/pnpm/store/v3"]

[phases.build]
dependsOn = ["install"]
cmds = [
    "echo 'ðŸ” [DEBUG] Starting Prisma generation for all schemas...'",
    "node --version && pnpm --version",
    "echo 'ðŸ“¦ [DEBUG] Running prisma:generate-all...'",
    "pnpm run prisma:generate-all",
    "echo 'âœ… [DEBUG] Prisma generation completed successfully'",
    "echo 'ðŸ—ï¸ [DEBUG] Starting SvelteKit build...'",
    "pnpm run build",
    "echo 'âœ… [DEBUG] Build completed successfully'"
]
cacheDirectories = ["node_modules/.cache"]

[start]
cmd = "node build"
