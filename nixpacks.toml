# Configuration Nixpacks pour Prisma 7
# Prisma 7 n√©cessite Node.js 20.19.0+ (docs: https://www.prisma.io/docs/orm/reference/system-requirements)
# NIXPACKS_NODE_VERSION=22 (d√©fini dans Coolify) + nixPkgs = ["nodejs", ...]

[variables]
CI = "true"
NODE_ENV = "production"
NPM_CONFIG_PRODUCTION = "false"

[phases.setup]
# Node.js 22 (NIXPACKS_NODE_VERSION=22 + nodejs dans nixPkgs requis avec config custom)
nixPkgs = ["nodejs", "pnpm-9_x", "openssl"]
nixLibs = ["libuuid", "libGL"]
aptPkgs = ["curl", "wget"]
nixOverlays = ["https://github.com/railwayapp/nix-npm-overlay/archive/main.tar.gz"]

[phases.install]
dependsOn = ["setup"]
cmds = ["pnpm i --frozen-lockfile"]
cacheDirectories = ["/root/.local/share/pnpm/store/v3"]

[phases.build]
dependsOn = ["install"]
cmds = [
    "echo 'üîç Node.js version:' && node --version",
    "echo 'üì¶ pnpm version:' && pnpm --version",
    "echo 'üìÇ Prisma schemas found:' && ls -la prisma/*/schema.prisma || true",
    "pnpm run prisma:generate-all",
    "echo '‚úÖ Prisma clients generated:' && ls -la src/generated/",
    "pnpm run build",
    "echo '‚úÖ Build output:' && ls -la build/"
]
cacheDirectories = ["node_modules/.cache"]

[start]
cmd = "node build"
